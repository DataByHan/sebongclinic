# Fix Cloudflare Pages async_hooks Error (Next 15 + next-on-pages)

## Recommended Approach (Pick ONE)

Downgrade from Next.js `15.5.2` to Next.js `14.2.x` and revert the small Next 15-only route handler `params: Promise<...>` patterns.

Why this option (minimal change + highest probability for current setup):
- The failure is caused by Next 15 edge-route bundling importing `node:async_hooks`, which Cloudflare Workers cannot satisfy.
- Your deployment stack is built around `@cloudflare/next-on-pages` (archived) and already uses Edge runtime route handlers; there is no stable, upstream patch to make Next 15 edge bundles stop importing async_hooks.
- Next 14 is known to work with `@cloudflare/next-on-pages` style builds (and does not introduce the Next 15 async `params` API change).

Non-goal: migrate to `@opennextjs/cloudflare` in this plan (bigger change surface). If you want that later, treat it as a separate migration project.

---

## Files You Will Modify

- `package.json`
- `package-lock.json` (auto-updated by npm install)
- `src/app/api/images/[...key]/route.ts`
- `src/app/api/notices/[id]/route.ts`

## Files/Dirs You Will Delete (Cache Clearing)

- `.next/`
- `.vercel/` (regenerated by next-on-pages)
- `tsconfig.tsbuildinfo`

Optional (only if you see stubborn dependency resolution issues):
- `node_modules/`

---

## Step-by-Step Commands (Run In Sequence)

### 0) Safety: work on a branch

```bash
git status
git checkout -b fix/cf-async-hooks
```

Pass/Fail:
- PASS: you are on `fix/cf-async-hooks` and working tree is unchanged (or you understand existing local changes).

### 1) Identify all Next 15-only API usage that must be reverted

```bash
grep -R "params: Promise<" -n src/app || true
grep -R "await params" -n src/app || true
grep -R "await cookies()" -n src/app || true
grep -R "await headers()" -n src/app || true
```

Pass/Fail:
- PASS: only the two route handler files show the `params: Promise` + `await params` pattern (as currently expected).
- FAIL: other matches exist; add them to the edit list and revert to Next 14 semantics (sync `params`, sync `cookies()/headers()` if present).

### 2) Edit route handlers back to Next 14 `params` semantics

Edit these files:
- `src/app/api/images/[...key]/route.ts`
  - Change handler signature from `{ params }: { params: Promise<{ key: string[] }> }` to `{ params }: { params: { key: string[] } }`.
  - Replace `const { key } = await params` with `const { key } = params`.
- `src/app/api/notices/[id]/route.ts`
  - In `GET`, `PUT`, `DELETE` handlers: change `{ params }: { params: Promise<{ id: string }> }` to `{ params }: { params: { id: string } }`.
  - Replace each `const { id } = await params` with `const { id } = params`.

Pass/Fail:
- PASS: TypeScript compiles and there are no remaining `await params` occurrences.

### 3) Downgrade Next.js (and align eslint config)

In `package.json`:
- Change `next` from `15.5.2` to `14.2.18` (pin exact).
- Change `eslint-config-next` to `14.2.18` (match Next major/minor).
- Keep `react` and `react-dom` at `^18.3.1` (compatible with Next 14).

Pass/Fail:
- PASS: `package.json` pins Next 14.2.18 and eslint-config-next 14.2.18.

### 4) Hard clean build artifacts (cache clearing)

```bash
rm -rf .next .vercel
rm -f tsconfig.tsbuildinfo
```

Optional if you want the cleanest possible install:
```bash
rm -rf node_modules
```

Pass/Fail:
- PASS: `.next/` and `.vercel/` are gone before reinstall/build.

### 5) Reinstall deps using the lockfile (or regenerate it)

Preferred (reproducible):
```bash
npm ci
```

If `npm ci` fails because lockfile is incompatible with the new Next version:
```bash
rm -rf node_modules
npm install
```

Pass/Fail:
- PASS: install completes with exit code 0.

### 6) Local build verification (Next build + next-on-pages build)

Run:
```bash
npm run build
npm run pages:build
```

Pass/Fail:
- PASS: both commands exit 0.
- FAIL: stop and fix compile/build errors before proceeding (most likely remaining Next 15 API usages).

### 7) Confirm the async_hooks import is gone from generated worker output

```bash
grep -R "async_hooks" -n .vercel/output/static || true
grep -R "node:async_hooks" -n .vercel/output/static || true
```

Pass/Fail:
- PASS: zero matches.
- FAIL: any match means the downgrade or build pipeline did not take effect; do not deploy.

### 8) Local runtime verification using Pages dev (API routes)

Start local preview (in a dedicated terminal):
```bash
npm run preview
```

In another terminal, verify endpoints (replace port if wrangler chooses a different one):
```bash
curl -i http://localhost:8788/api/notices

curl -i -X POST http://localhost:8788/api/notices \
  -H 'Content-Type: application/json' \
  -d '{"title":"test","content":"hello","password":"sebong2025"}'

curl -i -X POST http://localhost:8788/api/upload \
  -F 'password=sebong2025' \
  -F 'file=@public/favicon.ico'
```

Pass/Fail:
- PASS:
  - `GET /api/notices` returns `200` with JSON containing `notices` array (may be empty).
  - `POST /api/notices` returns `201` with JSON containing `id`, `title`, `content`.
  - `POST /api/upload` returns `200` with JSON containing `url` + `filename`.
- FAIL: any `500` with missing bindings indicates Pages dev isn’t receiving D1/R2 bindings; confirm Cloudflare Pages bindings and wrangler configuration (see next step).

### 9) Cloudflare Pages project settings verification (before pushing)

In Cloudflare Pages project settings, confirm:
- Functions compatibility flags include `nodejs_compat` (already in `wrangler.toml`).
- D1 binding exists: `DB`.
- R2 binding exists: `IMAGES`.
- Build command used by Pages is:
  - `npm run pages:build`
- Build output directory is:
  - `.vercel/output/static`

Pass/Fail:
- PASS: Pages uses the next-on-pages output directory (not `.next`).

---

## Deployment Procedure

### 10) Commit and push

```bash
git add package.json package-lock.json src/app/api/images/[...key]/route.ts src/app/api/notices/[id]/route.ts
git commit -m "fix: downgrade to next 14 for Cloudflare workers"
git push -u origin fix/cf-async-hooks
```

Then open a PR and merge, or push directly to `master` if that’s your normal flow.

### 11) Post-deploy verification (Cloudflare)

After Pages deploy completes:
- Check Cloudflare Pages Functions logs: confirm the async_hooks error is gone.
- Hit production endpoints:
  - `GET https://www.sebongclinic.co.kr/api/notices` returns 200
  - Create a notice from the admin UI and confirm it persists (D1)
  - Upload an image and confirm it loads via `/api/images/...` (R2)

Pass/Fail:
- PASS: No async_hooks error; API routes return expected status codes.

---

## Rollback Strategy (If Anything Fails)

Fast rollback is: revert the deploy commit.

Option A (recommended): revert merge commit (keeps history clean)
```bash
git checkout master
git pull
git revert <the-commit-sha>
git push
```

Option B: if failure happens before merge, just abandon the branch:
```bash
git checkout master
git branch -D fix/cf-async-hooks
```

Post-rollback checks:
- Cloudflare redeploy completes
- Functions logs no longer show new errors introduced by the attempted change

---

## Success Criteria (Definition of Done)

- `npm run pages:build` succeeds locally.
- `grep -R "node:async_hooks" .vercel/output/static` returns no matches.
- Cloudflare Pages Functions logs no longer show the async_hooks module error.
- Notices admin workflows work end-to-end in production:
  - create notice, list notices, edit notice, delete notice
  - upload image and view it via `/api/images/...`
